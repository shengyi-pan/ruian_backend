## 背景

项目任务：

- 使用 Python FastAPI 实现后端服务， UV 管理项目
- 使用 supabase postgresql 存放数据，后续会有 CRUD 功能

产品核心功能说明：

1. 用户先有登录验证
2. 登录能看到两份数据： 生产信息表 和 员工工作量表
3. 上传 Excel 文件，导入 生产信息 或 员工工作量 数据
4. 选定时间范围，校验两份数据的工作量能否匹配

### 整体架构

前端会使用 React， 后端 Python FastAPI， 数据库 postgresql
后端使用配置文件管理各种资源的连接和认证

允许各种跨域请求，后端接口都需要加 Head Auth， 使用固定的密钥（密钥存放在后端配置中）

### 数据库设计

需求：

- 将数据库表的定义和创建单独存放到一个文件
- 前期简单设计，一张数据库表对应一个对象; 存放在 src/app/model 下，已有 生产信息对应 ProductionInfo, 员工工作量 对应 EmployeeWorklog

包括以下表：

1. 用户登录验证表
   以用户名和密码做校验匹配；
   先不用支持注册功能，以脚本导入用户

2. 生产信息表

"""
-- 生产订单的工种配置与数量（来自“上传订单信息 Excel”）
CREATE TABLE production_info (
id BIGSERIAL PRIMARY KEY,
order_no TEXT NOT NULL, -- 生产订单号（如 2516572）
model TEXT NOT NULL, -- 产品型号（如 W/mG000-AMP）
brand_no TEXT NOT NULL, -- 牌号（如 GXZYD00652946）
quantity INTEGER NOT NULL CHECK (quantity > 0),
job_type TEXT NOT NULL, -- 工种（如 钝化 / 烧结）
performance_factor NUMERIC(6,2) NOT NULL CHECK (performance_factor > 0),
upload_date TIMESTAMPTZ NOT NULL DEFAULT now(), -- 上传日期（展示列）
created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),

-- 同一订单 + 型号 + 牌号 + 工种 + 上传日期 只保留一条，防重复导入
CONSTRAINT uq_prodinfo UNIQUE (order_no, model, brand_no, job_type, upload_date)
);

-- 常用查询索引
CREATE INDEX idx_prodinfo_order_date ON production_info (order_no, upload_date DESC);
CREATE INDEX idx_prodinfo_job_type ON production_info (job_type);
"""

3. 员工工作量表

"""
-- 员工按天的计件/工作量明细（来自“上传计件信息 excel”）
CREATE TABLE employee_worklog (
id BIGSERIAL PRIMARY KEY,
order_no TEXT NOT NULL, -- 生产订单号（如 2516572）
model TEXT, -- 型号（如 W/mG000-AMP）
brand_no TEXT, -- 牌号（如 07912）
employee_id TEXT NOT NULL, -- 工号（如 024）
employee_name TEXT, -- 姓名（如 张三）
job_type TEXT NOT NULL, -- 工种（如 钝化）
quantity INTEGER NOT NULL CHECK (quantity > 0),
performance_factor NUMERIC(6,2) NOT NULL CHECK (performance_factor > 0),
-- 绩效数量 = 数量 × 绩效系数
performance_amount NUMERIC(18,2) NOT NULL CHECK (performance_amount > 0),
work_date TIMESTAMPTZ NOT NULL DEFAULT now(), -- 工作日期（如 2025-11-08）
upload_date TIMESTAMPTZ NOT NULL DEFAULT now(), -- 导入日期（可选展示）
created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- 常用查询索引
CREATE INDEX idx_worklog_emp_date ON employee_worklog (employee_id, work_date DESC);
CREATE INDEX idx_worklog_order_date ON employee_worklog (order_no, work_date DESC);
CREATE INDEX idx_worklog_job_date ON employee_worklog (job_type, work_date DESC);
"""

4. 如果还需要其它表，一并设计定义

## 核心功能

### 登录验证

基于用户名和密码验证， 使用 JWT 方式

### 文件上传

上传接口要兼容两种文件类型的上传：生产信息 和 员工工作量

使用两种方案实现：

1. 后端接收文件存放在 uploads 文件下

2. 使用阿里云 OSS 对象存储服务
   2.1 核心链路

- 前端直传对象存储（预签名 URL / 客户端直传）
- 后端签发预签名 URL（含权限与限时），前端直传到对象存储，后端只接收回执/元数据。

### 文件解析

1. 前端上传完成后，后端触发解析；解析功能使用 src/utils/parse_util 中的方法
2. 需要解析的 Excel 包括 生产信息（parse_util.parse_production_excel） 和 员工工作量（parse_util.parse_employee_worklogs_from_excel），是两个不同的解析功能
3. 解析的数据存放到数据库中。需要去重存放：生产信息 使用 order_no, 员工工作量 使用 order_no 和 employee_id, 如果重复覆盖更新（不用新增数据）

### 数据查询

- 生产信息 按订单号、日期 的查询能力，也可以全量分页查询
- 员工工作量 按订单号、日期 的查询能力，也可以全量分页查询

### 数据核验

限定时间范围做数据核验：

1. 从数据库查询时间范围内的 production_info 和 employee_worklong
2. 使用 src/app/utils/data_vld 的 validate_production_and_worklog 校验数据， 返回校验结果
